# 入职时间
#### 2019年5月7号

## 第一周（5.7 - 5.11）
* 确定工作方向
* 学习python
* 了解python版本项目结构
* 两个小任务
  * 服务器端写一个全服广播功能模块
  * 客户端接入Unity Cloud Diagnostics
### 全服广播模块
* 一开始采用python中的pyee库来写，打算使用事件监听的方式进行广播
* 后听取了导师的指导，开发了全服广播基本功能
  * 根据广播文本进行广播播报
  * 根据广播id进行广播播报 
* 根据广播id进行广播的具体思路为：
  * 向配置表中加入广播标准文本，文本中有相应的通配符，每个文本有自己的id
  * 通过广播id得到广播标准文本，扫描字符串，进行通配符的替换
  * 将替换后的文本进行全服广播
* 全服广播实现方式即为：
  * 扫描字符串
  * 通配符替换
  * 通过事件监听器进行广播 

## 第二周（5.14 - 5.18）
* 完善广播功能模块
* 学习git基本流程（创建分支——转换分支——在分支上进行开发——commit——push），尝试将python版本的全服广播模块push到分支
* 尝试接入Unity Cloud Diagnostics，并编写了相关文档

## 第三周（5.21 - 5.25）
* 学习gs语言（数据类型、条件语句等）
* 尝试移植广播功能模块到gs版本
* 学习了敏感词屏蔽算法（前缀树）
* 了解gs版本项目结构

## 第四周（5.28 - 6.1）
* 完成gs版本广播功能模块的移植
* 向gs版本增加离线收益报告功能
  * 离线收益报告：
    * 离线收益总体报告
    * 秘境挂机详细报告
  * 具体实现其实是游戏逻辑的判断
  * 玩家离线存在两种状态：修炼、秘境两种挂机状态
  * 玩家若是修炼挂机状态退出的游戏，在其退出十分钟后会调用服务器登出玩家的方法将其角色真正的登出（避免掉线情况的出现），修炼的挂机状态仅用记录下服务器登出玩家时间，后用玩家登陆时间-登出时间这段时间来计算离线收益即可
  * 秘境挂机状态则需要考虑秘境挂机最大时间为8小时，故在玩家角色的心跳方法中进行判断：
    * 角色是离线状态
    * 角色挂机时间是否超过八个钟
  * 若是超过了八个钟即转变玩家挂机状态（改为修炼挂机），同时调用服务器登出玩家操作同时记录下登出时间，待玩家上线后实际离线收益为秘境挂机收益加上修炼挂机收益
    * 秘境挂机收益即为玩家登出时间-玩家退出游戏时间的收益
    * 修炼挂机收益即为玩家登陆时间-玩家登出时间的收益
  * 具体实现过程为，在玩家登陆的时候在相应的登陆回调方法中进行状态的判断计算相应的离线收益（离线超过十分钟（此时才有登出时间的记录）才显示离线收益报告），服务器登出玩家的时候进行报告数据的清零，报告数据的记录即在相应的操作下进行数据库的写入。

## 第五周（6.4 - 6.6）
* 修复一些提示相关的小问题
  *  涉及到了命令的处理
  *  项目中存在三个终端：客户端、主服务器、辅助服务器
  *  主服务器负责处理游戏的主要逻辑
  *  辅助服务器则是处理玩家社交、全服广播等功能
  *  主服务器上有一个MsgHandler管理器负责对命令的处理
  *  先将编写好的方法绑定到相应的命令上，再将命令集保存在handlers的一个map中，后对map中的命令进行注册，当服务器收到来自客户端或者辅助服务器的请求的时候就会调用相应的方法
* 移植GM功能模块
  * 其中有一个GM功能是定时关机
  * 在这里面服务器关机方法是一个同步的方法，因为关机的过程不同的模块之间存在依赖，便直接把先后顺序写在这个方法中
  * 同样的为了避免误操作，服务器关机方法有一个cookie进行是否执行方法的的验证
  * 调用服务器关机方法需要新开一个协程，在协程中进行服务器关机，因为服务器关机中会将服务器正在关机的标志位置为true，而为了确保关机的flag在各个协程中一致，便简单的进行了协程休眠0.1秒的处理

## 第六周（6.11 - 6.15）
* 负责python版本版号申请的相关修改
  * 文本修改 —— BOSS->首领
  * 增加PVP警告
    * 具体实现方法是玩家角色到达15级时将"show_pvp_warning"的标志位为true，然后玩家在进入秘境的时候会向数据库读这一标志位的值，如果是true就显示PVP警告，当玩家点击接受按钮后客户端向服务端发接受信息并将"show_pvp_warning"置为false
  * 商店页面增加充值按钮
  * 隐藏帮助按钮等等

* 负责回归测试相关问题的修复
  * 登录界面玩家停留超过一定时间就自动断开连接
    * 实际上是创建了ws后ws超过了一段时间没有对象绑定它就进行销毁操作，修改超时时间即可
  * 排行榜页面显示战力和查看玩家信息里页面的战力不一致
    * 由于排行榜信息是存于redis中的，redis相当于缓存，每隔60s进行数据的保存，故会存在战力不一致的情况
  * 人物战力 = 装备附加战力 + 技能附加战力 + 自身气血 + 自身真元的修复
    * 其中后两项的战力策划要求当玩家进入人物属性界面的时候进行一次战力的刷新
    * 解决方案是当客户端玩家点击了人物属性界面按钮时同时向服务端发送刷新战力的请求，服务器返回刷新后的战力

## 第七周（6.17 - 6.20）
* 跑通压力测试并出性能报告
  * 测试在500人/1000人/2000人/5000人的情况下,内存/CPU/延迟等数据的情况
    * 完善了压测客户端的代码逻辑，在py版本下内存/cpu的获取是通过python的psutil库来获取的，在gs中暂时没有实现这一功能，故编写了一个外部的py程序来获取
    * 由于服务器端是gs版本而压测客户端是py语言写的，故如果要测试延迟的话，单纯的服务器->客户端或者客户端->服务端是行不通的，因为底层获取毫秒级时间的实现有所差异
    * 解决方法是 服务器->客户端->服务器 取这段时间除以2
  * 希望测试机器人可以配置为指定等级的标准人（有装备、技能） 
  * 希望可以配置机器人在不同秘境的分布情况

## 第八周（6.24 - 6.29）
* 换线表现问题
  * 选择线路后，combobox没有改变
    * 实际原因是点击线路后向服务器发送请求，服务器收到请求执行的指令的为玩家分配一条最优线路，故线路没有改变，修改下代码逻辑即可

* 增加怪物脱战回血机制和属性调节
  * 增加怪物脱战回血机制
    * 需求是脱离战斗后每秒回复2%的血量（在calc表中配置）
    * 初步思路是将脱战回血写在心跳中，当怪物是脱战状态且残血就进行自动回复
    * 但原本心跳的逻辑是周围没有玩家，怪物就停止心跳，这与上面逻辑产生冲突
    * 故改为当周围没有玩家且满状态时才停止心跳，脱战回血至满状态停止心跳
  * 支持单独配置某一怪物的属性比例
  * 支持快速调节秘境怪物难度

* 离线相关调整
  * 离线状态保存
    * 当玩家切出游戏小于等于60s，保留玩家之前操作的界面
    * 当玩家切出游戏大于60s，进行重新连接
    * 产生这一需求的原因是，当玩家切出游戏的时候，客户端判断玩家切出就执行断线操作，故玩家切回来游戏会重新连接，界面也重置到主界面
    * 解决方案为加入标志位和定时器
  * 离线状态保存后续
    * 采用上面的方法实现离线状态保存后，在UNITY编辑器中测试功能正常，到模拟器上测试后就功能失效了
    * 应该是游戏切出后定时器就不会再工作了，也就不会自动重连了
    * 第二个解决方案即断开连接操作在服务器端进行
    * 原本打算继续采用信号（标志位）传递的方式来实现自动开关机，后发现仍是那个问题，当游戏切出后服务器向客户端发送的消息，客户端收不到
    * 最终的解决方法是当客户端切出时，记录时间并向服务器发送，服务器设置定时器和标志位来决定60s后要不要断开连接，当客户端切回来会向服务器发送“我已回来”类似的信号

* 统一游戏内所有系统的重置时间至上午八点
  * 每次刷新商店物品记录时间，当记录的时间与当前时间不在同一天 或者 记录的时间的小时小于8（这是保证已经是下一个刷新周期了），就继续判断当前时间的小时有没有超过8小时，就执行相应的重置操作

* 优化秘境怪物生成逻辑
  * 玩家主动点击地图/掉落物/怪物进行移动/拾取/攻击时，在未完成点击指令前不应自动反击或被其他目标吸引
    * 主要问题是战斗对象的心跳是按自动战斗状态处理的，因为战斗对象不仅有玩家，还包含了怪物，而怪物只有自动战斗状态，故玩家角色时刻都处于自动战斗状态
    * 解决方法就是若是手动状态就不执行自动战斗逻辑
      * gs中的.?方法调用，如果对象中有这个方法就调用，若是没有就返回void
  * 地图掉落物物品无法手动点击选取
    * 采集物不同于其他战斗对象，需要拎出来单独处理
  * 部分生成的怪物会原地不动
    * 之前的脱战回血的bug，怪物复活后没有进行状态的重置（其实进行了不过是在怪物死亡的时候，但是好像无效，不知道为什么）
  * 部分生成的怪物会突然消失
    * 怪物消失有两种情况
    * 一是怪物超时自动死亡（已修复）
      * 超时死亡的条件加入了若是旁边没有玩家才能执行的条件
    * 二是战斗对象视野问题
      * 会出现怪物突然消失，靠近后有再次出现的BUG 

* 机器人优化
  * 机器人设置标准人加入自动装备功能

## 第九周（7.1 - 7.6）
* 修复秘境相关BUG
  * 玩家自身底板改为透明
  * 手动战斗状态中角色不会自动移动
    * 控制角色行为的逻辑主要在心跳中，在心跳中加入限制条件判断玩家状态即可
  * 修复进入单人秘境报错
    * 进入秘境之后会创建一个combat_user对象，combat_user对象专门处理战斗事件的
  * 修复刚复活怪物的碰撞
    * 因为服务端复活单位没有向客户端同步属性(hp、mp)
  * 修复添加服务器端机器人报错
  * 修复普通攻击角色没有移动的BUG
  
* 神通系统逻辑修改
  * 修改神通遗忘学习逻辑
    * 现在不限制技能学习数量，但同时装备的技能最多为6个
      * 重新创建一张新表"learned_skills"存放已学习技能，原先的表"skills"作为已装备技能
      * 在此基础上进行神通系统逻辑修改

* 增加大境界衰减系数
  * 人物境界超过释放技能的技能，技能效果会有衰减
    * 需要注意的是，仅对神通技能有效，对怪物、人物技能与装备附带技能无效
    * 注意护盾类技能与伤害类技能数值计算是区别开的

* 支持秘境刷怪和刷洞府功能
  * 刷怪小工具
    * 将刷新点保存在文件上方便策划配置

## 第十周（7.8 - 7.11）
* 完善神通系统前端
  * 神通列表界面
  * 神通界面
  * 神通装配界面
  * 技能学习界面
* 前端界面之间的交互，注意好UI的事件和分辨率的适配就好了
* 发现了一个新的问题，由于后端一开始设计skills表和learned_skills是关联的，一个技能有变动另一张表中也会有变动，这样仅对learned_skills表进行操作即可
* 这时如果客户端重启，两表（指保存在客户端中的表）之间的关联就消失了，变成了“深拷贝”，故重启后需要重新对两张表进行同步
  * 最终的解决方法是在有技能操作的时候，对skills进行重新赋值
* 同样的如果服务器端重启，两表（指保存在服务器端的表）关联也不存在，也需要进行两表的重新同步

* 商城相关修改
  * 刷新逻辑调整
    * 根据玩家当前最大修炼等级决定各种类物品数量
    * 加入等级权重数值
    * 仙阁中class_id相同的物品最多只出现一个
  * 其他调整
    * 坊市中出售的丹方如果尚未解锁且包裹中无此丹方的时候,icon右上角有提示
    * 替换坊市购买按钮、物品栏、物品栏(点击)美术资源
    * 仙阁修改为坊市的竖状排版 

## 第十一周（7.15 - 7.20）
* 完善神通系统前端
  * 应策划和美术要求重新更改神通系统相关图片技能和UI特效等
  * 遇到了技能栏点击的相关问题
  * 技能栏分为已装备技能、可装备技能、未解锁三种状态
  * 其中已装备技能选中后技能栏外围有一层光圈
  * 这里使用了UGUI中的transition.SpritSwap的方法，但会导致一个问题，由于技能栏是一个prefab，同样的点击可装备技能或者未解锁技能栏也会出现同样的效果，显得很突兀
  * 原本解决方案是使用代码动态更改transition状态，但是项目前端开发使用的是lua语言，中间构件是Tolua，使用Tolua向transition赋值UnityEngine.UI.Selectable.Transition.ColorTint会报没有Transition错误（实际上官网API上也没有Transition这个枚举类，给的样例是C#语言的代码）
  * 最后曲线救国，在skills界面创建的时候先生成一个带有ColorTint的prefab和一个带有SpritSwap的prefab并保存下来后销毁掉这两个prefab，后对需要改变transition的object进行赋值就可以了

* 玩家体验优化
  * 增加了战斗包裹领取物品指引
  * 论道试炼任务超过自己3个小境界以上不能挑战